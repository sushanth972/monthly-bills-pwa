import React, { useState, useEffect, useMemo } from 'react';
import { 
  Plus, 
  Trash2, 
  CheckCircle2, 
  Circle, 
  Bell, 
  BellOff,
  Calendar, 
  IndianRupee,
  Repeat, 
  Upload, 
  Download, 
  Database, 
  AlertCircle,
  X
} from 'lucide-react';

/* --- Component to Inject PWA Meta Tags --- */
// This component ensures the browser knows to treat the app as a standalone application.
const PwaMetaTags = () => {
    useEffect(() => {
        const metaTags = [
            { name: "mobile-web-app-capable", content: "yes" }, // Crucial for Android standalone mode
            { name: "apple-mobile-web-app-capable", content: "yes" }, // For iOS compatibility
            { name: "theme-color", content: "#4f46e5" }, // Sets the color of the browser UI
            { name: "application-name", content: "MonthlyBills" },
            { name: "apple-mobile-web-app-title", content: "MonthlyBills" },
        ];

        metaTags.forEach(tagData => {
            let meta = document.querySelector(`meta[name="${tagData.name}"]`);
            if (!meta) {
                meta = document.createElement('meta');
                meta.setAttribute('name', tagData.name);
                document.head.appendChild(meta);
            }
            meta.setAttribute('content', tagData.content);
        });
    }, []);
    return null; // This component doesn't render any visible UI
};

export default function App() {
  const [expenses, setExpenses] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDataModalOpen, setIsDataModalOpen] = useState(false); 
  const [expenseToDelete, setExpenseToDelete] = useState(null);
  const [editingExpense, setEditingExpense] = useState(null); 
  const [notificationPermission, setNotificationPermission] = useState('default');
  
  // Form State
  const [name, setName] = useState('');
  const [amount, setAmount] = useState('');
  const [dateInput, setDateInput] = useState(''); 
  const [remind, setRemind] = useState(true);
  const [isRecurring, setIsRecurring] = useState(true);

  // Load data from LocalStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem('monthly_expenses');
    if (saved) {
      setExpenses(JSON.parse(saved));
    }
    
    if ('Notification' in window) {
      setNotificationPermission(Notification.permission);
    }
  }, []);

  // Save to LocalStorage whenever expenses change
  useEffect(() => {
    localStorage.setItem('monthly_expenses', JSON.stringify(expenses));
    checkReminders(expenses);
  }, [expenses]);

  /* --- Notification Handlers --- */
  const requestNotificationPermission = async () => {
    if (!('Notification' in window)) {
      console.error("This browser does not support desktop notifications.");
      return;
    }
    
    if (Notification.permission === 'granted' || Notification.permission === 'denied') {
        setNotificationPermission(Notification.permission);
        return;
    }
    
    try {
      const permission = await Notification.requestPermission();
      setNotificationPermission(permission);
      
      if (permission === 'granted') {
        new Notification("Reminders Enabled", {
          body: "We will remind you when bills are due!",
          icon: "/icon.png" 
        });
      }
    } catch (error) {
        console.error("Error requesting notification permission:", error);
    }
  };

  const checkReminders = (currentExpenses) => {
    if (notificationPermission !== 'granted') return;

    const today = new Date();
    const currentDay = today.getDate();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

    const upcoming = currentExpenses.filter(exp => {
      if (exp.remind === false) return false;
      if (isPaidThisMonth(exp)) return false;

      let diff = exp.dueDay - currentDay;
      if (diff < 0) diff += daysInMonth; 

      return diff >= 0 && diff <= 3;
    });

    if (upcoming.length > 0) {
       // Trigger browser notification here if needed
    }
  };

  const isPaidThisMonth = (expense) => {
    const now = new Date();
    const currentKey = `${now.getFullYear()}-${now.getMonth()}`;
    return expense.paidHistory && expense.paidHistory.includes(currentKey);
  };

  const togglePaid = (id) => {
    const now = new Date();
    const currentKey = `${now.getFullYear()}-${now.getMonth()}`;

    setExpenses(prev => prev.map(exp => {
      if (exp.id !== id) return exp;
      
      const history = exp.paidHistory || [];
      let newHistory;
      
      if (history.includes(currentKey)) {
        newHistory = history.filter(h => h !== currentKey);
      } else {
        newHistory = [...history, currentKey];
      }
      
      return { ...exp, paidHistory: newHistory };
    }));
  };
  
  /* --- Edit/Add/Delete Handlers --- */

  const resetFormState = () => {
    setName('');
    setAmount('');
    setDateInput('');
    setRemind(true);
    setIsRecurring(true);
    setEditingExpense(null);
  }

  const closeModal = () => {
    setIsModalOpen(false);
    resetFormState();
  }

  const openEditModal = (expense) => {
    const today = new Date();
    const formattedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(expense.dueDay).padStart(2, '0')}`;

    setEditingExpense(expense);
    setName(expense.name);
    setAmount(expense.amount.toString());
    setDateInput(formattedDate);
    setRemind(expense.remind ?? true);
    setIsRecurring(expense.isRecurring ?? true);
    setIsModalOpen(true);
  }

  const handleSaveExpense = (e) => {
    e.preventDefault();
    if (!name || !amount || !dateInput) return;

    const day = parseInt(dateInput.split('-')[2]);

    const updatedExpense = {
      id: editingExpense ? editingExpense.id : Date.now(),
      name,
      amount: parseFloat(amount),
      dueDay: day,
      remind: isRecurring ? remind : false, 
      isRecurring: isRecurring, 
      paidHistory: editingExpense ? editingExpense.paidHistory : []
    };

    if (editingExpense) {
      setExpenses(prev => prev.map(exp => 
        exp.id === updatedExpense.id ? updatedExpense : exp
      ));
    } else {
      setExpenses(prev => [...prev, updatedExpense]);
    }

    closeModal();
  };

  const confirmDelete = (id) => {
    setExpenseToDelete(id);
  };

  const performDelete = () => {
    if (expenseToDelete) {
      setExpenses(expenses.filter(e => e.id !== expenseToDelete));
      setExpenseToDelete(null);
    }
  };

  /* --- Backup/Restore Handlers --- */
  
  const handleExport = () => {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(localStorage.getItem('monthly_expenses') || '[]');
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", `MonthlyBills_Backup_${new Date().toISOString().slice(0, 10)}.json`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    setIsDataModalOpen(false);
  };

  const handleImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const json = e.target.result;
        const importedExpenses = JSON.parse(json);

        if (Array.isArray(importedExpenses)) {
          const isValid = importedExpenses.every(item => item.id && item.name && typeof item.amount === 'number');
          
          if (isValid) {
            setExpenses(importedExpenses);
            setIsDataModalOpen(false);
          } else {
            console.error("Import failed: The file format is invalid or missing critical fields."); 
          }
        } else {
          console.error("Import failed: The file does not contain a valid expense array.");
        }
      } catch (error) {
        console.error("Error parsing JSON:", error);
      }
    };
    reader.readAsText(file);
  };

  /* --- Calculations and Formatting --- */
  const totalMonthly = expenses.reduce((acc, curr) => acc + curr.amount, 0);
  
  const totalPaid = expenses.reduce((acc, curr) => {
    return isPaidThisMonth(curr) ? acc + curr.amount : acc;
  }, 0);

  const totalPending = totalMonthly - totalPaid;

  const filteredAndSortedExpenses = useMemo(() => {
    const filtered = expenses.filter(exp => {
      if (exp.isRecurring === false && isPaidThisMonth(exp)) {
        return false;
      }
      return true;
    });

    return [...filtered].sort((a, b) => {
      const aPaid = isPaidThisMonth(a);
      const bPaid = isPaidThisMonth(b);
      if (aPaid === bPaid) {
        return a.dueDay - b.dueDay;
      }
      return aPaid ? 1 : -1;
    });
  }, [expenses]);

  const getStatusColor = (expense) => {
    const today = new Date().getDate();
    if (isPaidThisMonth(expense)) return 'bg-green-50 border-green-200';
    if (expense.dueDay < today) return 'bg-red-50 border-red-200'; 
    if (expense.dueDay <= today + 3) return 'bg-yellow-50 border-yellow-200'; 
    return 'bg-white border-gray-100';
  };

  const getNextDueDateFormatted = (expense) => {
    const today = new Date();
    const paid = isPaidThisMonth(expense);
    
    let targetMonth = today.getMonth();
    if (paid && expense.isRecurring !== false) targetMonth += 1; 

    const date = new Date(today.getFullYear(), targetMonth, expense.dueDay);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  const getStatusText = (expense) => {
    const today = new Date().getDate();
    
    if (expense.isRecurring === false) {
      return isPaidThisMonth(expense) ? 'Paid (One-Time)' : 'One-Time';
    }

    if (isPaidThisMonth(expense)) return 'Paid';
    if (expense.dueDay === today) return 'Due Today!';
    if (expense.dueDay < today) return `Overdue by ${today - expense.dueDay} days`;
    const daysLeft = expense.dueDay - today;
    return `Due in ${daysLeft} days`;
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20">
      
      {/* PWA Meta Tags Injector */}
      <PwaMetaTags />

      {/* Header */}
      <header className="bg-indigo-600 text-white p-6 pb-12 rounded-b-[2rem] shadow-lg">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl font-bold flex items-center gap-2">
            <Calendar className="w-6 h-6" /> MonthlyBills
          </h1>
          <div className="flex gap-2">
            <button 
                onClick={() => setIsDataModalOpen(true)}
                className="p-2 rounded-full bg-indigo-500 text-indigo-200 hover:bg-indigo-700 transition-colors"
            >
                <Database className="w-5 h-5" />
            </button>
            <button 
              onClick={requestNotificationPermission}
              className={`p-2 rounded-full ${notificationPermission === 'granted' ? 'bg-indigo-500 text-indigo-200' : 'bg-white text-indigo-600 animate-pulse'}`}
            >
              <Bell className="w-5 h-5" />
            </button>
          </div>
        </div>

        <div className="flex justify-between items-end">
          <div>
            <p className="text-indigo-200 text-sm font-medium mb-1">Left to Pay</p>
            <p className="text-4xl font-bold">₹{totalPending.toLocaleString()}</p>
          </div>
          <div className="text-right">
             <p className="text-indigo-200 text-xs mb-1">Total Budget</p>
             <p className="font-semibold">₹{totalMonthly.toLocaleString()}</p>
          </div>
        </div>
      </header>

      {/* Stats Cards */}
      <div className="px-6 -mt-8 grid grid-cols-2 gap-4 mb-6">
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
          <span className="text-xs text-gray-400 uppercase font-bold tracking-wider">Paid</span>
          <span className="text-xl font-bold text-green-600">₹{totalPaid.toLocaleString()}</span>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
          <span className="text-xs text-gray-400 uppercase font-bold tracking-wider">Progress</span>
          <span className="text-xl font-bold text-indigo-600">
            {totalMonthly > 0 ? Math.round((totalPaid / totalMonthly) * 100) : 0}%
          </span>
        </div>
      </div>

      {/* Expense List */}
      <div className="px-4 space-y-3">
        <h2 className="text-sm font-bold text-gray-400 uppercase tracking-wider px-2">Your Bills</h2>
        
        {filteredAndSortedExpenses.length === 0 ? (
          <div className="text-center py-10 text-gray-400">
            <p>No active expenses yet.</p>
            <p className="text-sm">Tap + to add one.</p>
          </div>
        ) : (
          filteredAndSortedExpenses.map(expense => (
            <div 
              key={expense.id} 
              className={`flex items-center justify-between p-4 rounded-xl border shadow-sm transition-all ${getStatusColor(expense)}`}
            >
              {/* Feature 4: Click card to edit */}
              <div className="flex items-center gap-4 w-full" onClick={() => openEditModal(expense)}>
                <button 
                  onClick={(e) => { e.stopPropagation(); togglePaid(expense.id); }}
                  className="focus:outline-none transition-transform active:scale-95"
                >
                  {isPaidThisMonth(expense) ? (
                    <CheckCircle2 className="w-6 h-6 text-green-500" />
                  ) : (
                    <Circle className="w-6 h-6 text-gray-300 hover:text-indigo-500" />
                  )}
                </button>
                <div className="flex-1">
                  <h3 className={`font-semibold ${isPaidThisMonth(expense) ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                    {expense.name}
                  </h3>
                  <div className="flex flex-col">
                    <p className={`text-xs flex items-center gap-1 ${isPaidThisMonth(expense) ? 'text-gray-400' : 'text-indigo-600 font-medium'}`}>
                      {getStatusText(expense)} 
                      {/* Show Bell only if recurring, not paid, and reminders are on */}
                      {expense.isRecurring !== false && expense.remind !== false && !isPaidThisMonth(expense) && (
                        <Bell className="w-3 h-3 ml-1" />
                      )}
                    </p>
                    <p className="text-[10px] text-gray-400 font-medium mt-0.5">
                      {expense.isRecurring !== false && `Next Due: ${getNextDueDateFormatted(expense)}`}
                      {expense.isRecurring === false && !isPaidThisMonth(expense) && `Due on: ${getNextDueDateFormatted(expense)}`}
                    </p>
                  </div>
                </div>
              </div>
              
              <div className="flex items-center gap-3">
                <span className={`font-bold ${isPaidThisMonth(expense) ? 'text-gray-400' : 'text-gray-800'}`}>
                  ₹{expense.amount}
                </span>
                <button 
                  onClick={(e) => { e.stopPropagation(); confirmDelete(expense.id); }}
                  className="text-gray-300 hover:text-red-400 p-1"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* FAB */}
      <button 
        onClick={() => { resetFormState(); setIsModalOpen(true); }}
        className="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 active:scale-90 transition-all z-10"
      >
        <Plus className="w-8 h-8" />
      </button>

      {/* Delete Confirmation Modal */}
      {expenseToDelete && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full animate-in zoom-in-95 duration-200">
            <h3 className="text-lg font-bold text-gray-800 mb-2">Delete Expense?</h3>
            <p className="text-gray-500 mb-6">Are you sure you want to remove this expense permanently?</p>
            <div className="flex gap-3">
              <button 
                onClick={() => setExpenseToDelete(null)}
                className="flex-1 py-3 text-gray-600 bg-gray-100 font-bold rounded-xl hover:bg-gray-200 transition-colors"
              >
                Cancel
              </button>
              <button 
                onClick={performDelete}
                className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition-colors"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Data Management Modal (Backup/Restore) */}
      {isDataModalOpen && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full animate-in zoom-in-95 duration-200">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Database/> Data Management</h3>
              <button onClick={() => setIsDataModalOpen(false)} className="p-2 bg-gray-100 rounded-full">
                <X className="w-5 h-5 text-gray-600" />
              </button>
            </div>
            
            <p className="text-sm text-gray-500 mb-4">Your data is stored only on this device. Use these options for backup.</p>

            <div className="space-y-4">
              {/* Export Button */}
              <button 
                onClick={handleExport}
                className="w-full flex items-center justify-center gap-2 py-3 bg-indigo-100 text-indigo-700 font-bold rounded-xl hover:bg-indigo-200 transition-colors"
              >
                <Download className="w-5 h-5" /> Export Data (JSON Backup)
              </button>

              {/* Import Button */}
              <label htmlFor="import-file" className="w-full flex items-center justify-center gap-2 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors cursor-pointer">
                <Upload className="w-5 h-5" /> Import Data (Restore)
                <input 
                  type="file" 
                  id="import-file" 
                  accept=".json" 
                  onChange={handleImport} 
                  className="hidden" 
                />
              </label>
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Expense Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center z-50 p-4">
          <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 fade-in duration-200">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-xl font-bold text-gray-800">
                {editingExpense ? 'Edit Bill' : 'Add New Bill'}
              </h2>
              <button onClick={closeModal} className="p-2 bg-gray-100 rounded-full">
                <X className="w-5 h-5 text-gray-600" />
              </button>
            </div>

            <form onSubmit={handleSaveExpense} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Expense Name</label>
                <input 
                  type="text" 
                  placeholder="e.g. Rent, Netflix"
                  className="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  autoFocus
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Amount (₹)</label>
                  <div className="relative">
                    <IndianRupee className="w-4 h-4 absolute left-3 top-3.5 text-gray-400" />
                    <input 
                      type="number" 
                      placeholder="0.00"
                      className="w-full p-3 pl-9 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500"
                      value={amount}
                      onChange={(e) => setAmount(e.target.value)}
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                  <input 
                    type="date" 
                    className="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-indigo-500"
                    value={dateInput}
                    onChange={(e) => setDateInput(e.target.value)}
                    required
                  />
                </div>
              </div>
              
              {/* Recurrence Toggle (Feature 5) */}
              <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <div className="flex items-center gap-2">
                  <div className={`p-2 rounded-full ${isRecurring ? 'bg-indigo-100 text-indigo-600' : 'bg-gray-200 text-gray-500'}`}>
                    <Repeat className="w-5 h-5" />
                  </div>
                  <div>
                    <p className="text-sm font-medium text-gray-800">Expense Type</p>
                    <p className="text-xs text-gray-500">{isRecurring ? 'Repeats Monthly' : 'One-Time Cost'}</p>
                  </div>
                </div>
                <label className="relative inline-flex items-center cursor-pointer">
                  <input 
                    type="checkbox" 
                    className="sr-only peer"
                    checked={isRecurring}
                    onChange={(e) => setIsRecurring(e.target.checked)}
                  />
                  <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
              </div>

              {/* Reminder Toggle (Only shown if Recurring) */}
              {isRecurring && (
                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                  <div className="flex items-center gap-2">
                    <div className={`p-2 rounded-full ${remind ? 'bg-indigo-100 text-indigo-600' : 'bg-gray-200 text-gray-500'}`}>
                      {remind ? <Bell className="w-5 h-5" /> : <BellOff className="w-5 h-5" />}
                    </div>
                    <div>
                      <p className="text-sm font-medium text-gray-800">Monthly Reminder</p>
                      <p className="text-xs text-gray-500">Notify 3 days before due</p>
                    </div>
                  </div>
                  <label className="relative inline-flex items-center cursor-pointer">
                    <input 
                      type="checkbox" 
                      className="sr-only peer"
                      checked={remind}
                      onChange={(e) => setRemind(e.target.checked)}
                    />
                    <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                  </label>
                </div>
              )}

              <button 
                type="submit"
                className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl mt-4 hover:bg-indigo-700 transition-colors"
              >
                {editingExpense ? 'Update Expense' : 'Save Expense'}
              </button>
            </form>
          </div>
        </div>
      )}

    </div>
  );
}
